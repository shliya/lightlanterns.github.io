<!doctype html>
<html>
    <head>
        <link rel="stylesheet" href="./src/css/main.css" />
        <link rel="stylesheet" href="./src/lightbox/css/lightbox.css" />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Cubic+11&display=swap"
            rel="stylesheet"
        />
    </head>

    <body>
        <header>
            <div class="container">
                <marquee class="hit-hinet">
                    ÂÖàÂàÆ 5 Ê†ºÔºåÂÜçÈÅ∏‰∏ÄË°åÔΩûÈÅ∏Âà∞ 1„Éª2„Éª3 Â∞±‰∏≠ÁçéÔºÅ
                </marquee>
            </div>
        </header>

        <div class="container scratch-section">
            <p class="draw-text scratch-hint">
                ÂÖàÈªû 5 Ê†ºÂàÆÈñãÔºåÂÜçÈÅ∏‰∏ÄË°åÔΩûË©≤Ë°åÊòØ 1„Éª2„Éª3 Âç≥‰∏≠Áçé
            </p>
            <p class="draw-text" id="scratch-count-show">Â∑≤ÂàÆÔºö0 / 5</p>
            <div id="scratch-grid-wrapper" class="scratch-grid-wrapper">
                <div id="scratch-grid" class="scratch-grid"></div>
                <div
                    id="line-pick-indicators"
                    class="line-pick-indicators"
                    aria-hidden="true"
                ></div>
            </div>
            <div
                id="line-pick-section"
                class="line-pick-section"
                style="display: none"
            >
                <p class="draw-text line-pick-hint">
                    ÈÅ∏‰∏ÄË°åÈñãÁçéÔºàÈªûÁÆ≠È†≠ÊàñÊâãÊåáÔºâ
                </p>
            </div>
            <button type="button" id="btn-rescratch" class="btn-rescratch">
                ÂÜçÊäΩ‰∏ÄÊ¨°
            </button>
        </div>

        <div id="fallback-section" class="container" style="display: none">
            <p class="draw-text">ÊäΩ 10 ÁõûÁáà</p>
            <div id="image-container"></div>
        </div>

        <footer>
            <div class="container">
                <marquee class="hit-hinet">
                    ÂÖàÂàÆ 5 Ê†ºÔºåÂÜçÈÅ∏‰∏ÄË°åÔΩûÈÅ∏Âà∞ 1„Éª2„Éª3 Â∞±‰∏≠ÁçéÔºÅ
                </marquee>
            </div>
        </footer>

        <div id="daily-limit-modal" class="modal-overlay" style="display: none">
            <div class="modal-box">
                <p id="daily-limit-message" class="modal-message"></p>
                <div id="daily-limit-buttons" class="modal-buttons"></div>
            </div>
        </div>

        <script>
            const GOOGLE_DRIVE_URL =
                'https://drive.google.com/drive/folders/1gQi0-62H-QFOEVcYfiqVw72ztgF4mN41';
            const IMAGE_BASE_PATH = './src/image/manylight/2025/';
            const MAX_SCRATCH = 5;
            const MAX_DAILY_PLAYS = 6;
            const STORAGE_KEY_DAILY = 'scratchDaily';
            const WIN_SET = new Set([1, 2, 3]);

            const WIN_LINES = [
                { indices: [0, 1, 2], label: 'Ê©´‰∏Ä' },
                { indices: [3, 4, 5], label: 'Ê©´‰∫å' },
                { indices: [6, 7, 8], label: 'Ê©´‰∏â' },
                { indices: [0, 3, 6], label: 'Áõ¥‰∏Ä' },
                { indices: [1, 4, 7], label: 'Áõ¥‰∫å' },
                { indices: [2, 5, 8], label: 'Áõ¥‰∏â' },
                { indices: [0, 4, 8], label: 'ÊñúÔºº' },
                { indices: [2, 4, 6], label: 'ÊñúÔºè' },
            ];

            let gridNumbers = [];
            let scratchCount = 0;
            let scratchedSet = new Set();
            let gameEnded = false;

            const scratchGridEl = document.getElementById('scratch-grid');
            const scratchCountShowEl =
                document.getElementById('scratch-count-show');
            const linePickSectionEl =
                document.getElementById('line-pick-section');
            const scratchGridWrapperEl = document.getElementById(
                'scratch-grid-wrapper',
            );
            const linePickIndicatorsEl = document.getElementById(
                'line-pick-indicators',
            );
            const btnRescratchEl = document.getElementById('btn-rescratch');
            const fallbackSectionEl =
                document.getElementById('fallback-section');
            const imageContainerEl = document.getElementById('image-container');
            const dailyLimitModalEl =
                document.getElementById('daily-limit-modal');
            const dailyLimitMessageEl = document.getElementById(
                'daily-limit-message',
            );
            const dailyLimitButtonsEl = document.getElementById(
                'daily-limit-buttons',
            );

            function getTodayDateString() {
                const d = new Date();
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return y + '-' + m + '-' + day;
            }

            function getDailyPlayState() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY_DAILY);
                    if (!raw) return { date: '', count: 0 };
                    const data = JSON.parse(raw);
                    const today = getTodayDateString();
                    if (data.date !== today) return { date: today, count: 0 };
                    return data;
                } catch {
                    return { date: getTodayDateString(), count: 0 };
                }
            }

            function saveDailyPlayState(state) {
                localStorage.setItem(STORAGE_KEY_DAILY, JSON.stringify(state));
            }

            function incrementDailyPlay() {
                const state = getDailyPlayState();
                const today = getTodayDateString();
                if (state.date !== today) {
                    state.date = today;
                    state.count = 0;
                }
                state.count += 1;
                saveDailyPlayState(state);
                return state.count;
            }

            function canStartNewGame() {
                return getDailyPlayState().count < MAX_DAILY_PLAYS;
            }

            function disableRescratchButton() {
                btnRescratchEl.disabled = true;
                btnRescratchEl.classList.add('btn-rescratch-disabled');
            }

            function showDailyLimitModal() {
                dailyLimitMessageEl.textContent =
                    'ÈÄôÈÇä‰∏çÊòØÈáëËù∂‰∏çÊ≤âËø∑ÔºåÊòéÂ§©ÂÜç‰æÜÁé©ÔºåÂø´ÂõûÂéª';
                dailyLimitButtonsEl.innerHTML =
                    '<button type="button" class="btn-modal btn-modal-yes">ÊòØ</button>' +
                    '<button type="button" class="btn-modal btn-modal-no">Âê¶</button>';
                dailyLimitModalEl.style.display = 'flex';

                const btnYes =
                    dailyLimitButtonsEl.querySelector('.btn-modal-yes');
                const btnNo =
                    dailyLimitButtonsEl.querySelector('.btn-modal-no');

                btnYes.onclick = function () {
                    dailyLimitModalEl.style.display = 'none';
                    disableRescratchButton();
                };

                btnNo.onclick = function () {
                    dailyLimitMessageEl.textContent = '‰∏çÁÑ∂Áµ¶‰Ω†Ëá™Â∑±ÊÖ¢ÊÖ¢Êâæ';
                    dailyLimitButtonsEl.innerHTML =
                        '<button type="button" class="btn-modal btn-modal-ok">Â•Ω</button>';
                    const btnOk =
                        dailyLimitButtonsEl.querySelector('.btn-modal-ok');
                    btnOk.onclick = function () {
                        window.open(GOOGLE_DRIVE_URL, '_blank');
                        dailyLimitModalEl.style.display = 'none';
                        disableRescratchButton();
                    };
                };
            }

            function shuffleArray(arr) {
                const a = [...arr];
                for (let i = a.length - 1; i > 0; i--) {
                    const j =
                        (crypto.getRandomValues(new Uint32Array(1))[0] %
                            (i + 1)) >>>
                        0;
                    [a[i], a[j]] = [a[j], a[i]];
                }
                return a;
            }

            function buildGrid() {
                gridNumbers = shuffleArray([1, 2, 3, 4, 5, 6, 7, 8, 9]);
                scratchGridEl.innerHTML = '';
                gridNumbers.forEach((num, index) => {
                    const cell = document.createElement('div');
                    cell.className = 'scratch-cell';
                    cell.dataset.index = String(index);
                    cell.innerHTML =
                        '<span class="scratch-number">' +
                        num +
                        '</span><div class="scratch-cover" aria-hidden="true"></div>';
                    scratchGridEl.appendChild(cell);
                });
            }

            function updateScratchCount() {
                scratchCountShowEl.textContent =
                    'Â∑≤ÂàÆÔºö' + scratchCount + ' / ' + MAX_SCRATCH;
            }

            function getLineValues(indices) {
                return indices.map((i) => gridNumbers[i]);
            }

            function isLineWin(indices) {
                const values = getLineValues(indices);
                const valueSet = new Set(values);
                return (
                    valueSet.size === 3 && values.every((v) => WIN_SET.has(v))
                );
            }

            function revealAllCells() {
                scratchGridEl
                    .querySelectorAll('.scratch-cover')
                    .forEach((cover) => cover.classList.add('scratched'));
            }

            function buildLinePickIndicators() {
                linePickIndicatorsEl.innerHTML = '';
                const rowIcon = 'üëâ';
                const colIcon = 'üëá';
                const diagIcons = ['‚Üò', '‚Üô'];
                WIN_LINES.forEach((line, idx) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'line-pick-indicator btn-line-pick';
                    btn.dataset.lineIndex = String(idx);
                    if (idx <= 2) {
                        btn.className += ' line-pick-row';
                        btn.setAttribute('data-row', String(idx));
                        btn.textContent = rowIcon;
                        btn.title = line.label;
                    } else if (idx <= 5) {
                        btn.className += ' line-pick-col';
                        btn.setAttribute('data-col', String(idx - 3));
                        btn.textContent = colIcon;
                        btn.title = line.label;
                    } else {
                        btn.className += ' line-pick-diag';
                        btn.setAttribute('data-diag', String(idx - 6));
                        btn.textContent = diagIcons[idx - 6];
                        btn.title = line.label;
                    }
                    linePickIndicatorsEl.appendChild(btn);
                });
                scratchGridWrapperEl.classList.add('has-line-pick');
                linePickIndicatorsEl.style.display = 'block';
            }

            function showLinePickSection() {
                buildLinePickIndicators();
                linePickSectionEl.style.display = 'block';
            }

            function revealCellsByIndices(indices) {
                indices.forEach((i) => {
                    const cell = scratchGridEl.querySelector(
                        '[data-index="' + i + '"]',
                    );
                    if (!cell) return;
                    const cover = cell.querySelector('.scratch-cover');
                    if (cover && !cover.classList.contains('scratched')) {
                        cover.classList.add('scratched');
                    }
                    cell.classList.add('chosen-line');
                });
            }

            function hideLinePickSection() {
                linePickSectionEl.style.display = 'none';
                linePickIndicatorsEl.innerHTML = '';
                linePickIndicatorsEl.style.display = 'none';
                scratchGridWrapperEl.classList.remove('has-line-pick');
            }

            function goToPrize() {
                window.location.assign(GOOGLE_DRIVE_URL);
            }

            function showFallbackImages() {
                fallbackSectionEl.style.display = 'block';
                imageContainerEl.innerHTML = '';
                let imagesLoaded = 0;
                const total = 10;

                for (let i = 0; i < total; i++) {
                    const randomNumber =
                        (crypto.getRandomValues(new Uint16Array(1))[0] % 400) +
                        1;
                    const formatted = String(randomNumber).padStart(2, '0');
                    const imageUrl = IMAGE_BASE_PATH + formatted + '.png';

                    const a = document.createElement('a');
                    a.href = imageUrl;
                    a.setAttribute('data-lightbox', 'image-set');
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.classList.add('drawn-image');
                    img.onload = () => {
                        imagesLoaded++;
                        if (imagesLoaded === total) {
                            document
                                .querySelectorAll(
                                    '#image-container .drawn-image',
                                )
                                .forEach((el) => {
                                    el.classList.add('fade-in');
                                });
                        }
                    };
                    a.appendChild(img);
                    imageContainerEl.appendChild(a);
                }
            }

            function finishRound(won) {
                gameEnded = true;
                if (won) {
                    goToPrize();
                    return;
                }
                showFallbackImages();
            }

            function onCellClick(ev) {
                if (gameEnded) return;
                const cover = ev.target
                    .closest('.scratch-cell')
                    ?.querySelector('.scratch-cover');
                if (!cover || cover.classList.contains('scratched')) return;
                if (scratchCount >= MAX_SCRATCH) return;

                const cell = cover.closest('.scratch-cell');
                const index = parseInt(cell.dataset.index, 10);
                scratchedSet.add(index);
                scratchCount++;
                cover.classList.add('scratched');
                updateScratchCount();

                if (scratchCount >= MAX_SCRATCH) {
                    showLinePickSection();
                }
            }

            function onLinePick(ev) {
                if (gameEnded) return;
                const btn = ev.target.closest('.btn-line-pick');
                if (!btn) return;
                const lineIndex = parseInt(btn.dataset.lineIndex, 10);
                const line = WIN_LINES[lineIndex];
                if (!line) return;
                gameEnded = true;
                revealCellsByIndices(line.indices);
                const won = isLineWin(line.indices);
                finishRound(won);
            }

            function resetGame() {
                if (!canStartNewGame()) {
                    showDailyLimitModal();
                    return;
                }
                incrementDailyPlay();
                gridNumbers = [];
                scratchCount = 0;
                scratchedSet = new Set();
                gameEnded = false;
                fallbackSectionEl.style.display = 'none';
                imageContainerEl.innerHTML = '';
                hideLinePickSection();
                buildGrid();
                updateScratchCount();
            }

            function init() {
                if (!canStartNewGame()) {
                    disableRescratchButton();
                }
                buildGrid();
                updateScratchCount();
                scratchGridEl.addEventListener('click', (ev) => {
                    if (
                        ev.target.closest('.scratch-cover') ||
                        ev.target.closest('.scratch-cell')
                    ) {
                        onCellClick(ev);
                    }
                });
                linePickIndicatorsEl.addEventListener('click', onLinePick);
                btnRescratchEl.addEventListener('click', resetGame);
            }

            init();
        </script>
        <script src="./src/lightbox/js/lightbox-plus-jquery.js"></script>
    </body>
</html>
